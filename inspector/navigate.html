<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8"/>
        <title>Habitat Inspector</title>        
        <link rel="stylesheet" href="style.css">
        <script type="importmap">
            {
                "imports": {
                    "htm": "./vendor/htm.mjs",
                    "preact": "./vendor/preact.mjs",
                    "preact/hooks": "./vendor/hooks.mjs",
                    "@preact/signals-core": "./vendor/signals-core.mjs",
                    "@preact/signals": "./vendor/signals.mjs"
                }
            }
        </script>
        <script type="module">
            // import "https://esm.sh/*preact/devtools"
            import { html } from "./view.js"
            import { h, render } from "preact"
            import { useState, useId, useCallback, useMemo } from "preact/hooks"
            import { regionView, regionSearch, itemView } from "./region.js"
            import { contextMap, useJson, useHabitatJson } from "./data.js"
            import { direction } from "./view.js"
            import { Scale } from "./render.js"
            import { navigate, connectionsFromRef } from "./neohabitat.js"

            const itemLink = ({ item }) => item ? html`
                <a href="region.html?f=${item.filename}">${item.name}</a><br/>
                <${regionView} filename=${item.filename}/>` : null
            
            const moveNames = { n: "north", e: "east", w: "west", s: "south" }
            const navMove = ({ fromref, dir, orientation }) => {
                const compass = moveNames[dir]
                if (compass) {
                    return html`<${direction} compass=${compass} orientation=${orientation}/>`
                }
                const filename = contextMap()[fromref]?.filename
                if (filename) {
                    const obj = useHabitatJson(filename).find(o => o.ref == dir)
                    if (obj) {
                        return html`<span>through <div style="display: inline-block"><${Scale.provider} value="1"><${itemView} object=${obj} standalone="true"/><//></div></span>`
                    }
                }
            }
            const directions = ({ start, end }) => {
                if (!start || !end) {
                    return null
                }
                const neighbormap = useJson("db/neighbormap.json", {})
                const path = useMemo(() => {
                    return navigate(start.ref, end.ref, neighbormap)
                }, [start, end, neighbormap])
                if (path.length < 2) {
                    return html`<i>Sorry, there's no way to get to ${end.name} from ${start.name}!</i>`
                }
                const directions = []
                for (let ipath = 0; ipath < (path.length - 1); ipath ++) {
                    const fromref = path[ipath] 
                    const toref = path[ipath + 1]
                    const to = contextMap()[toref]
                    const { orientation, connections } = connectionsFromRef(neighbormap, fromref)
                    const dir = Object.entries(connections).find(([dir, ref]) => ref == toref)[0]
                    directions.push(html`
                        <li>Go <${navMove} dir=${dir} orientation=${orientation} fromref=${fromref}/> towards <${itemLink} item=${to}/></li>`)
                }
                return html`
                        <ul>
                            <li>Starting from <${itemLink} item=${start}/></li>
                            ${directions}
                        </ul>`
            }
            const nav = () => {
                const [start, setStart] = useState(null)
                const [end, setEnd] = useState(null)

                return html`
                    <${Scale.Provider} value="1">
                        <p>
                            <${regionSearch} label="Start location:" onSelected=${setStart}/>
                            <${itemLink} item=${start}/>
                        </p>
                        <p>
                            <${regionSearch} label="End location:" onSelected=${setEnd}/>
                            <${itemLink} item=${end}/>
                        </p>
                        <p><${directions} start=${start} end=${end}/></p>
                    <//>
                `
            }
            render(html`<${nav}/>`, document.getElementById('content'))
        </script>
    </head>
    <body>
        <h1>Habitat Pathfinder</h1>
        <div id="content"></div>
        <hr>
        <a href="index.html">Home</a>
    </body>
</html>